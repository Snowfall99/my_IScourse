# 第八章 网络互联
## 网络互联-IP协议
- 在网络层，Internet可以看成是自治系统的集合，是由网络组成的网络
- 网络之间互联的纽带是IP协议
- 与IP协议配套使用的四个协议
    - 地址解析协议ARP
    - 逆地址解析协议RARP
    - 网际控制报文协议ICMP
    - 网际组管理协议IGMP
- 互联设备的类型
    1. 转发器、集线器（Hub）：物理层中继系统
    1. 网桥、交换机：数据链路层中继系统
    1. 路由器：网络层中继系统
    1. 网关：比网络层更高层次上的中继系统
- 互联网指用路由器进行互联的网络
- 级联虚电路工作过程
    - 建立连接
        - 当目的主机不在子网内时，则在子网内找一个离目的网络最近的路由器，与之建立一条虚电路
        - 该路由器与外部网关建立虚电路
        - 该网关与下一个子网中的一个路由器建立虚电路
        - 重复上述操作，直到到达目的主机
    - 传输数据
        - 相同链接的包沿同一虚电路按序号传输
        - 网关根据需要转换包格式和虚电路号
    - 拆除链接
- 无连接网络互联
    - 每个包单独路由，提高网络利用率。但不能保证包按顺序到达
    - 根据需要，连接不同子网的多协议路由器做协议转换，包括包格式转换和地址转换等
- 级联虚电路与无连接网络互联的比较
    - 级联虚电路的优点：
        1. 路由器预留缓冲区等资源，保证服务质量
        1. 包按序号传输
        1. 短包头
    - 级联虚电路的缺点
        1. 路由器需要大量的内存，存储虚电路信息
        1. 一旦发生拥塞，没有其他路由
        1. 如果网络中有一个不可靠的数据报子网，级联虚电路很难实现
    - 无连接网络互联的优点
        1. 能够容忍拥塞，并能适应拥塞
        1. 健壮性好
        1. 可用于多种网络互联
    - 无连接网络互联的缺点
        1. 长包头
        1. 包不能保证按序号到达
        1. 不能保证服务质量
## LAN的扩展（LAN互联）
- Hub
    - 原理
        1. Hub从某一端口A将收到的帧发送到所有端口
        1. 非广播帧时，地址与帧目的的MAC地址相同的站响应用户A
        1. 广播帧时，所有用户都响应用户A
- 网桥
    - 不足之处
        - 存储转发导致时延增加
        - 无流量控制功能，负载重时会丢失帧
        - 不饿能防止广播风暴
- 交换机和交换式以太网
    - 交换机的帧转发方式
        1. 直接交换方式：只要接收并检测到目的地址就将该帧转发出去，而不管这一帧数据是否出错
        1. 存储转发方式：交换机先完整接收数据帧进行差错检测再转发
        1. 改进的直接交换方式：接收数据帧的前64字节，判断字头段正确再转发
    - 交换机的两种用法：
        1. 端口下接站点：站点独占10Mbps带宽
        1. 端口下接网段：网段中所有站点共享10Mbps带宽
- 虚拟局域网VLAN
    - 优点：
        1. 便于进行网络的管理
        1. 增强了网络的安全性
        1. 抑制了广播数据的泛滥
        1. 减少了处理用户站点移动所带来的开销
    - VLAN建立在网络交换机基础上
    - VLAN的划分方法：
        1. 基于交换机端口的划分方法
        1. 基于MAC地址的划分方法
        1. 基于网络层的划分方法
        1. 基于子网的划分方法
- 在一个局域网上的主机或路由器的IP地址中的网络号必须是一样的
- 路由器总是有两个或两个以上的IP地址。路由器的每个接口都有一个不同网络号的IP地址
- 网络层及以上使用IP地址
- 链路层及以下使用硬件地址
- 路由器只根据目的站的IP地址网络号进行路由选择
- 在具体的物理网络的链路层只能看见MAC帧而看不见IP数据报
- ARP解决同一个局域网上的主机或路由器的IP地址和硬件地址的映射问题，如果要找的主机和源主机不在同一个局域网上，那么就要通过ARP找到一个位于本局域网上的某个路由器的硬件地址，然后把分组发送给这个路由器，让这个路由器把分组转发给下一个网络
# IP数据包的格式
- IP数据报由首部和数据两部分组成
- 首部前一部分是固定长度，共20字节
- 版本：占4位，指IP协议的版本
- 首部长度：占4位，可表示的最大数值是15个单位（一个单位是4字节），因此IP的首部长度最大值是60字节
- 总长度：占16位，指首部和数据之和的长度，因此数据报的最大长度为65535字节，总长度必须不能超过最大传输单元MTU
- 标识：占16位
- 标志（Flag）：占3位，标志字段的最低位是MF，MF=1表示后面还有“分片”；MF=0表示最后一个分片。标志字段的中间一位是DF，只有当DF=0时才允许分片
- 片偏移（12位）：较长分组在分片后某片在原分组中的相对位置，片偏移以8个字节为偏移单位
- 生存时间（TTL，8位）：数据报在网络中可通过的路由器数的最大值
- 协议（8位）：数据报携带的数据使用何种协议
- 首部校验和（16位）：首部校验和会在传播途中发生变化
# 分段
- 分段应满足的条件：
    1. 各段在不大于MTU的情况下，尽可能大
    1. 端的长度为8的整数倍
- 原数据包的报头作为每段的数据包报头
- IP协议采用非透明重组，主机将遵循：要么成功，要么全部丢弃的原则

- 当路由器收到待转发的数据报，不是将下一跳路由器的IP地址填入IP数据报，而是送交下层网络接口软件
- 网络接口软件使用ARP负责将下一跳路由器的IP地址转换成硬件地址，并将此硬件地址放在链路层MAC帧的首部，然后根据这个硬件地址找到下一跳路由器
# 子网划分
- 子网掩码：IP地址 and 子网掩码 = 网络地址
- 三级IP地址（{<网络号><子网号><主机号>}）
- 子网和主机所需位数的分配：可以根据子网数或者每个子网中的主机数来决定
# 无分类编址CIDR
- CIDR使用各种长度的“网络前缀”来代替分类地址中的网络号和子网号
- 一个CIDR地址块可以表示很多地址，这种地址的聚合常称为路由聚合，它使得路由表中的一个项目可以表示很多个原来传统分类地址的路由
- 路由聚合也称为构成超网
- CIDR地址块中的地址数一定是2的整数次幂
- 最长前缀匹配
# 网际控制报文协议ICMP
- ICMP允许主机或路由器报告差错情况和提供有关异常情况的报告
- ICMP不是高层协议，而是IP层协议
- 两种ICMP报文：ICMP差错报告报文，ICMP询问报文
- PING使用了ICMP报文回送请求和回送回答报文，没有通过传输层的TCP和UDP
# 自治系统
- 尽管一个AS使用了多种内部路由选择协议和度量，但重要的是一个AS对其他AS表现出的是一个单一和一致的路由选择策略
- 两大路由选择协议：
    1. 内部网关协议IGP
    1. 外部网关协议EGP
- 内部网关协议RIP：
    - 基于距离向量的路由选择协议
    - RIP要求网络中的每一个路由器都要维护从它自己到其它每一个目的网络的距离记录
    - 仅和相邻路由器交换信息
    - 交换的信息是当前本路由器所知道的全部信息，即自己的路由表
    - 按固定的时间间隔交换路由信息
- 内部网关协议OSPF：
    - 向本自治系统所有路由器发送消息，使用洪泛法
    - 发送的消息就是与本路由器相邻的所有路由器的链路状态，但是这只是路由器所知道的部分信息
    - 只有当链路状态发生变化时，路由器才用洪泛法向所有路由器发送此消息
    - OSPF直接用IP数据报发送
- 外部网关协议BGP
- 网际组管理协议IGMP
# 网络地址转换NAT
- 所有使用本地地址的主机和外界通信时都要在NAT路由器上将其本地地址装换成IP，才能和因特网连接